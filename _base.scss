@use "colors" as *;
@use "settings" as *;
@use "sass:map";
@use "sass:list";

@mixin apply-colors($bg, $fg, $contrast) {
  @each $key, $value in map.get($bg, $contrast) {
    --#{$key}: #{$value};
  }
  @each $key, $value in $fg {
    --#{$key}: #{$value};
  }
}

@mixin btn-3d {
  box-shadow:
    inset 0px 0px 0px 1px rgb(0 0 0 / 5%),
    inset 0px -3px 0px 0px rgb(0 0 0 / 15%) !important;

  .dark & {
    box-shadow:
      inset 0px 0px 0px 1px rgb(0 0 0 / 5%),
      inset 0px -3px 0px 0px rgb(0 0 0 / 25%) !important;
  }
}

/* -------------------------------------------- */
/* ---------------- Root styles --------------- */
/* -------------------------------------------- */

html.dark {
  /* Everforest colors */
  @include apply-colors($dark-bg, $dark-fg, map.get($settings, contrast-dark));

  /* Mochi variables */
  --mochi--card--background: var(--bg1);
  --mochi--card-box--background: var(--bg1);
  --mochi--button--background: var(--bg1);
  --mochi--side-bar--background: var(--bg-dim);
  --mochi--card--background-hover: var(--bg-blue);

  --mochi--box-select--background: var(--bg0);
  --mochi--box-select--background-hover: var(--bg-blue);

  --mochi--side-bar-icon--color: var(--blue);
  --mochi--review-history--row-background-dark: var(--bg-dim);

  --mochi--button-hover--background: var(--bg-blue);
  --mochi----border-color: var(--bg3);

  --mochi--side-bar-item-selected--background: var(--bg1);
}

html:not(.dark) {
  /* Everforest colors */
  @include apply-colors(
    $light-bg,
    $light-fg,
    map.get($settings, contrast-light)
  );

  /* Mochi variables */
  --mochi--card--background: var(--bg0);
  --mochi--card-box--background: var(--bg0);
  --mochi--button--background: var(--bg0);
  --mochi--side-bar--background: var(--bg3);
  --mochi--card--background-hover: var(--bg-green);

  --mochi--box-select--background: var(--bg2);
  --mochi--box-select--background-hover: var(--bg5);

  --mochi--side-bar-icon--color: var(--grey2);
  --mochi--review-history--row-background-dark: var(--bg3);

  --mochi--button-hover--background: var(--bg5);

  --mochi--side-bar-item-selected--background: var(--bg5);
}

html body {
  --fonts-monospace: #{map.get($settings, font-monospace)};

  --mochi--review-button--background: var(--mochi--side-bar--background);
  --mochi--card--color: var(--fg);

  --mochi--md-code--background: var(--bg2);
  --mochi--cloze-2--background-color: var(--mochi--side-bar--background);
  --mochi----background-color: var(--bg0);

  --mochi--jump-to--selection-bg: var(--bg2);
  --mochi--show-more--background: var(--mochi--side-bar--background);
  --mochi--show-more--background-hover: var(--bg5);

  --mochi--progressbar--foreground: var(--bg5);

  --mochi--inverted-button--background: var(--grey2);
  --mochi--inverted-button--count-background: var(--grey0);
  --mochi--inverted-button-hover--background: var(--grey1);

  --mochi--progressbar--foreground-red: var(--statusline3);
  --mochi--re-review--icon: var(--red);

  // --mochi--card-note-view--editor-background:
  --mochi--card--border-color-active: var(--bg5);
  --mochi--md-hr--border-small: 1px dashed var(--grey0);
}

/* -------------------------------------------- */
/* ------------- memo_views edits ------------- */
/* -------------------------------------------- */

/* Main content background */
.memo_views_frame_frame-container {
  background-color: var(--bg1);
  background-size: 50px 50px;

  /* Background pattern - dots */
  background-image: radial-gradient(
    circle,
    hsla(37, 38%, 83%, 1) 1px,
    rgba(0, 0, 0, 0) 1px
  );

  .dark & {
    background-color: var(--bg0);
    background-image: radial-gradient(
      circle,
      hsla(31, 27%, 25%, 1) 1px,
      rgba(0, 0, 0, 0) 1px
    );
  }
}

/* Add bg to the top bar of main content to hide the dot pattern */
.memo_views_pages_deck_breadcrumbs-container {
  background-color: var(--bg1);
  .dark & {
    background-color: var(--bg0);
  }
}

/* Fix dashbaord overview background anomoly */
.memo_views_pages_layout_frame-content > div:nth-child(3) {
  background-color: initial !important;
}

/* Show More gradient */
.memo_views_atoms_card_tile-fade {
  background: linear-gradient(0deg, var(--bg0), var(--bg0) 33px, transparent);

  .dark & {
    background: linear-gradient(0deg, var(--bg1), var(--bg1) 33px, transparent);
  }

  .memo_views_card_list-view_card-container:hover &,
  .memo_views_card_grid-view_card-container:hover & {
    background: linear-gradient(
      0deg,
      var(--bg-green),
      var(--bg-green) 33px,
      transparent
    );

    .dark & {
      background: linear-gradient(
        0deg,
        var(--bg-blue),
        var(--bg-blue) 33px,
        transparent
      );
    }
  }
}

/* Editor background */
.memo_views_modal_card_editor-background {
  background-color: var(--bg1);
  font-size: 0.95em !important;

  .dark & {
    background-color: var(--bg0);
  }
}

/* Cards font color */
.memo_views_modal_modal-dialog {
  color: var(--fg);
}

/* Fix filter menu colors in dark mode */
.dark .memo_views_atoms_menu_menu {
  color: rgba(255, 255, 255, 0.7);
}

/* Cloze backgrounds */
.memo_views_diagrams_diagram-cloze {
  background-color: var(--grey1);
}

/* Make foot note jumps smooth */
.memo_views_modal_modal-container {
  scroll-behavior: smooth;
}

/* 3D button effect */
.memo_views_atoms_button_default-button,
.memo_views_atoms_button_inverted-button {
  @include btn-3d;
}

/* Grid view */
.memo_views_card_grid-view_container {
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
}

/* Column view */
.memo_views_card_column-view_left-column-container {
  width: 330px;
  border-left: none;
  border-right: none;
}

.memo_views_pages_deck_breadcrumbs-container {
  border: none !important;
}

.memo_views_card_column-view_right-column-container {
  color: var(--fg);
  background-color: var(--mochi--card--background);
  padding: 0; /* Remove the think border in editing mode */
}

.memo_views_card_column-view_column-row-markdown-container,
.memo_views_card_grid-view_card-container {
  h1 {
    font-size: 1.1em !important;
    font-weight: 600 !important;
  }

  h2,
  h3,
  h4 {
    font-size: 1em !important;
  }
}

/* Reset opacity of cards in column view */
.memo_views_card_column-view_column-row-markdown-container .paragraph {
  opacity: 1;
}

/* Remove divider lines in note footer in column view */
.memo_views_molecules_card-info_content-wrapper {
  // background-color: var(--mochi--side-bar--background);
  & > div + div {
    border: none;
    margin-top: 0;
  }
}

/* Remove box shadow */
.memo_views_card_column-view_column-row-container {
  box-shadow: none;
}

.memo_views_card_column-view_right-column-outer-container {
  border-radius: 8px;
  margin: 10px 10px 10px 0;
  border: 1px solid var(--mochi----border-color);
}

.memo_views_card_column-view_editor-styles {
  padding: 3em 3em 30vh 3em; /* Compensate for removing outer padding */
}

.memo_views_card_column-view_side-class {
  padding: 3em 3em 5em; /* Match padding to editing mode */
}

/* -------------------------------------------- */
/* ----------- memo_markdown edits ------------ */
/* -------------------------------------------- */

/* Cards font family */
.memo_markdown_styles_markdown-class {
  // font-family: Avenir !important;
}

/* Tags - inline and in card status */
.memo_markdown_components_tag-link {
  font-family: var(--fonts-monospace);
  padding: 3px;
  border: 1px solid var(--bg4);
}

/* Inline code style */
code:not(pre code):not(kbd code) {
  color: var(--blue) !important;
  border: 1px solid;
  white-space: nowrap; /* prevent work break for inline code */
  margin-right: 0.1em; /* prevent trailing punctuations touching the border */
}

/* Highlighted text with == */
.memo_markdown_styles_markdown-class mark {
  border-radius: 0;
  color: var(--bg0);
  background-color: var(--aqua);
  background-image: none;
  padding: 0.2em;
  margin: initial;
  vertical-align: middle;
}

/* Reference card links */
.memo_markdown_components_inline-link {
  // white-space: normal;

  /* Custome styles */
  background: var(--bg2);
  border: 1px solid var(--bg4);

  .dark & {
    background: var(--bg3);

    &:hover {
      background: var(--bg4);
    }
  }
}

/* Increase monospace font */
/* Only for UbutntuMono Nerd Mono font because it's inherently smaller */
.memo_markdown_styles_markdown-class code,
.memo_markdown_styles_markdown-class pre {
  font-size: 0.95em !important;
}

/* Used for footnote legends */
.memo_markdown_components_blue-link {
  // font-family: "Cascadia code";
  opacity: 0.9;

  h1 &,
  h2 &,
  h3 &,
  h4 &,
  h5 &,
  h6 & {
    font-size: initial;
  }
}

/* -------------------------------------------- */
/* ----------- Raw HTML tags edits ------------ */
/* -------------------------------------------- */

strong {
  color: var(--statusline3);
}

em {
  color: var(--aqua);
}

strong em {
  color: var(--purple);
}

/* ----------------- Headings ----------------- */

/* General */
h1,
h2,
h3,
h4,
h5,
h6 {
  font-family: map.get($settings, font-heading);
  font-weight: 500 !important;
  text-wrap: balance; /* Not yet supported in the Electron version Mochi is using */
}

/* Font size */
h2 {
  font-size: 1.8em !important;
}

h3 {
  font-size: 1.5em !important;
}

h4 {
  font-size: 1.3em !important;
}

h5 {
  font-size: 1em !important;
}

h6 {
  font-size: 1em !important;
}

@if map.get($settings, rainbow-headings) {
  /* Rainbow headings */
  $rainbow-colors: map.get($settings, rainbow-colors);
  @for $i from 1 through list.length($rainbow-colors) {
    h#{$i} {
      color: var(--#{list.nth($rainbow-colors, $i)});
    }
  }
}

/* -------- Custom keyboard input style ------- */

kbd {
  font-family: var(--fonts-monospace);
  color: var(--statusline3) !important;
  background: var(--bg2);
  border-radius: 4px;
  padding: 0.2em 0.45em;
  margin-right: 0.1em;
  white-space: nowrap;

  .dark & {
    background: var(--bg0);
  }

  @include btn-3d;
}

/* ------------------ Tables ------------------ */

table {
  border-radius: 5px;
  overflow: hidden;
}

thead tr {
  background-color: var(--bg-green);
}

tbody tr:nth-child(odd) {
  background-color: var(--bg2);
}

tbody tr:nth-child(even) {
  background-color: var(--bg1);
}

/* ------------ Custom list styles ------------ */

@if map.get($settings, custom-ol-bullet) {
  ol > li,
  ul > li {
    position: relative;
  }

  ol > li {
    list-style-type: none;
  }

  /* Custom numbered bullets */
  ol > li::before {
    --bullet-size: 1.3rem;
    content: counter(list-item);
    position: absolute;
    top: 0.4rem;
    inset-inline-start: -1.7rem;
    width: var(--bullet-size);
    height: var(--bullet-size);
    line-height: var(--bullet-size);
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
    color: var(--fg);
    background-color: var(--bg2);
    border-radius: 99rem;
    box-shadow: inset 0 0 0 1px var(--bg4);
    font-family: Cascadia Code;

    .dark & {
      background-color: var(--bg3);
      border-radius: 99rem;
      box-shadow: inset 0 0 0 1px var(--bg5);
    }
  }

  /* Indent lines */
  ol > li::after,
  ul > li::after {
    content: "";
    position: absolute;
    top: 2rem;
    bottom: 5px;
    inset-inline-start: -1.1rem;
    width: 1px;
    background-color: var(--bg4);
  }

  ul > li::after {
    inset-inline-start: -0.9rem;
  }
}

/* Experimental */
hlr,
hla {
  font-family: var(--fonts-monospace);
  padding: 2px 6px;
  border-radius: 3px;
  border: 1px solid;
  background-color: var(--bg2);
}

hlr {
  color: var(--red);
}

hla {
  color: var(--orange);
}
